# Kyverno Policy for Task 01 Validation
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: task-01-validation
  annotations:
    policies.kyverno.io/title: Task 01 Deployment Validation
    policies.kyverno.io/category: Task Validation
    policies.kyverno.io/description: >-
      Validates that deployments in task-01 namespace meet the required specifications
spec:
  validationFailureAction: enforce
  background: false
  rules:
  - name: validate-nginx-deployment
    match:
      any:
      - resources:
          kinds:
          - Deployment
          namespaces:
          - task-01
          names:
          - nginx-web
    validate:
      message: "Deployment must meet task-01 requirements"
      pattern:
        metadata:
          labels:
            app: nginx-web
        spec:
          replicas: 3
          selector:
            matchLabels:
              app: nginx-web
          template:
            metadata:
              labels:
                app: nginx-web
            spec:
              containers:
              - name: "nginx"
                image: "nginx:1.25"
                ports:
                - containerPort: 80
                resources:
                  requests:
                    cpu: "50m"
                    memory: "64Mi"
                  limits:
                    cpu: "100m"
                    memory: "128Mi"

  - name: validate-namespace-resources
    match:
      any:
      - resources:
          kinds:
          - Deployment
          namespaces:
          - task-01
    validate:
      message: "Only nginx-web deployment allowed in task-01 namespace"
      pattern:
        metadata:
          name: nginx-web

  - name: require-resource-limits
    match:
      any:
      - resources:
          kinds:
          - Deployment
          namespaces:
          - task-01
    validate:
      message: "All containers must have resource limits and requests"
      pattern:
        spec:
          template:
            spec:
              containers:
              - name: "*"
                resources:
                  requests:
                    cpu: "?*"
                    memory: "?*"
                  limits:
                    cpu: "?*"
                    memory: "?*"